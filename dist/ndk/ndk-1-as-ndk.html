<!DOCTYPE html><html><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><title>## 前情提要 - Android NDK开发之旅</title><meta name="description" content=""><meta name="author" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><link rel="stylesheet" href="../assets/css/bulma.min.css"><link rel="stylesheet" href="../assets/css/app.css"><!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]--><link rel="shortcut icon" href=""></head><body dir="ltr"><nav class="columns navbar"><div class="column logo is-3 is-offset-1"><a class="is-brand" href="../index.html">Android NDK开发之旅</a></div></nav><div class="columns content"><div class="column is-2-desktop is-3-widescreen is-hidden-touch"></div><div class="column article-container is-11-tablet is-8-desktop is-6-widescreen"><div class="breadcrumb-area"><a href="../index.html" class="breadcrumb-item">Home</a><span class="breadcrumb-delimiter"> &gt; </span><a href="../ndk/index.html" class="breadcrumb-item">Android NDK编写</a><span class="breadcrumb-delimiter"> &gt; </span><a href="../ndk/ndk-1-as-ndk.html" class="breadcrumb-item">使用Android-Studio编写NDK</a></div><h1 class="article-title">## 前情提要</h1><div class="article"><p>上个系列，我们学习了Java与C/C<ins>的交互 ， 使用Java调用C/C</ins>函数，使用C/C++调Java的方法和创建Java对象等等 。在上个系列中 ， 我们使用的是Eclipse与VS进行的开发 ， 在NDK系列中 ， 我们将采用最新的Android Studio进行开发 ， 版本是<code>Android studio 2.2 RC 2</code> ， NDK版本采用的是最新的<code>r12b</code> 。</p><h3 id="开发环境">开发环境 <a class="markdownIt-Anchor" href="#开发环境">#</a></h3><p>工具下载地址 （win）（需要科学上网） :<br>Android Studio 2.2 RC2 --- <a href="https://dl.google.com/dl/android/studio/ide-zips/2.2.0.11/android-studio-ide-145.3253452-windows.zip" target="_blank" rel="noopener">Android Studio Download 2.2 RC2</a><br>Android NDK r12b --- <a href="https://dl.google.com/android/repository/android-ndk-r12b-windows-x86_64.zip" target="_blank" rel="noopener">Android NDK r12b 64bit</a><br>Android NDK r12b --- <a href="https://dl.google.com/android/repository/android-ndk-r12b-windows-x86.zip" target="_blank" rel="noopener">Android NDK r12b 32bit</a></p><blockquote><p>国内镜像站：<br><a href="http://www.androiddevtools.cn/" target="_blank" rel="noopener">androiddevtools</a></p></blockquote><h3 id="关于开发环境的说明">关于开发环境的说明 <a class="markdownIt-Anchor" href="#关于开发环境的说明">#</a></h3><p>因为在<code>Android studio 2.2</code>之前的版本 ， 对C/C++支持不是很好 ， 也没有语法提示 ， 写起来不是很方便 ， 构建工具也不是很完整 ， 所有采用最新的<code>Android studio 2.2 RC2</code>来进行编写 ，但 ， <code>Android studio 2.2 RC2</code> 还是Beta版本 ，所有 ， 不建议现在应用到生产环境中 ， 等google发布了Stable版本之后再应用 。 目前建议 ， 可以使用<code>Eclipse</code>编写<code>.so</code> ， 然后应用到现在的生产环境中 。</p><h3 id="创建ndk项目">创建NDK项目 <a class="markdownIt-Anchor" href="#创建ndk项目">#</a></h3><blockquote><p>第一步 ， 创建支持C++的项目</p></blockquote><figure><img src="http://upload-images.jianshu.io/upload_images/643851-b15dc1376c8c2430.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="C++ support"><figcaption>C</figcaption></figure><p>其他的选项使用默认的即可 。</p><blockquote><p>第二步 ， 关联NDK</p></blockquote><p>创建完成之后会报如下错误：</p><figure><img src="http://upload-images.jianshu.io/upload_images/643851-0b70deabda8b9346.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ndk r12b"><figcaption>ndk r12b</figcaption></figure><p>在项目配置中 ， 关联NDK之后就会ok</p><figure><img src="http://upload-images.jianshu.io/upload_images/643851-3fe9ba5c00088b07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="config ndk"><figcaption>config ndk</figcaption></figure><blockquote><p>第三步 ， 编写native类及处理方法</p></blockquote><p>在创建项目的时候 ， 勾选了C++ support ， 项目创建完成之后 ， 会自动帮我们生成一个<code>cpp/native-lib.cpp</code></p><figure><img src="http://upload-images.jianshu.io/upload_images/643851-e5a5ebc788106c83.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="auto create cpp file"><figcaption>auto create cpp file</figcaption></figure><p>你可以不用修改文件名 ， 在新建<code>native</code>方法的时候 ， 会提示你创建一个C++的JNI函数 ， 直接创建就会生成一个JNI函数 ， 都不用使用<code>javah</code>生成一个头文件 ， 然后再引入头文件了 ， 非常之方便 。</p><figure><img src="http://upload-images.jianshu.io/upload_images/643851-91231d255bd06de6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="auto create jni function 1"><figcaption>auto create jni function 1</figcaption></figure><p>创建函数：</p><figure><img src="http://upload-images.jianshu.io/upload_images/643851-a0bbc2ac186a1601.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="auto create jni function 2"><figcaption>auto create jni function 2</figcaption></figure><p>在这里 ， 就不使用默认的<code>.cpp</code>文件了 ， 我们新建一个<code>.c</code>文件 ， 创建了<code>HelloNDK.c</code>文件之后 ， Android Studio会提示我们 ， 需要在<code>Android.mk/CMakeLists.txt</code>中进行声明 ， 这里 ， 我们使用默认的<code>CMakeLists.txt</code>建构工具 （创建项目的时候自动生成）。</p><blockquote><p>第四步 ， build.gradle配置：</p></blockquote><pre class="hljs"><code>externalNativeBuild {  
  cmake {       
     cppFlags <span class="hljs-string">""</span>       
     <span class="hljs-comment">// 指定只用clang编译器        </span>
    <span class="hljs-comment">// Clang是一个C语言、Objective-C、C++语言的轻量级编译器。  </span>
    arguments <span class="hljs-string">"-DANDROID_TOOLCHAIN=clang"</span>        
    <span class="hljs-comment">// 生成.so库的目标平台        </span>
    abiFilters <span class="hljs-string">"armeabi-v7a"</span> , <span class="hljs-string">"armeabi"</span>    
    }
}

<span class="hljs-comment">// 配置CMakeLists.txt路径</span>
externalNativeBuild { 
   cmake {        
      path <span class="hljs-string">"CMakeLists.txt"</span>   
   }
}
</code></pre><blockquote><p>第五步 ， 修改CMakeLists.txt</p></blockquote><pre class="hljs"><code>add_library( # Sets the name of the library.
             HelloNDK  # 生成的.so库文件名称

             # Sets the library as a shared library.
             SHARED

             # Provides a relative path to your source file(s).
             # Associated headers in the same location as their source
             # file are automatically included.
             # 需要生成的.so库的文件路径
             src/main/cpp/HelloNDK.c
 )

target_link_libraries( # Specifies the target library.
                       # 项目链接的.so库名称
                       HelloNDK

                       # Links the target library to the log library
                       # included in the NDK.
                       ${log-lib} )
</code></pre><blockquote><p>第六步 ， 编写<code>native</code>方法，以及C函数</p></blockquote><pre class="hljs"><code><span class="hljs-comment">/**
 * Created by Zeno on 2016/9/10.
 *
 * NDK Demo
 */</span>

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloNDK</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">sayHelloNDK</span><span class="hljs-params">()</span> </span>;

    <span class="hljs-keyword">static</span> {
        System.loadLibrary(<span class="hljs-string">"HelloNDK"</span>);
    }
}

</code></pre><pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;jni.h&gt;</span></span>
<span class="hljs-function">JNIEXPORT jstring <span class="hljs-title">JNICALLJava_com_zeno_encryptanddecrypt_ndk_HelloNDK_sayHelloNDK</span><span class="hljs-params">(JNIEnv *env, jclass thiz)</span> </span>{   
     <span class="hljs-comment">// TODO    </span>
     <span class="hljs-keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="hljs-string">"this String come from C "</span>);
}
</code></pre><p><code>native</code>方法的编写以及C函数的写法， 我们都非常熟悉了 ， 这里就不再解释各自的意义了 。</p><blockquote><p>第七步 ， 编译</p></blockquote><figure><img src="http://upload-images.jianshu.io/upload_images/643851-f8174b491f430b00.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="make"><figcaption>make</figcaption></figure><p>编译完成之后 ，我们可以切换到<code>project</code>视图，来查看<code>.so</code>文件</p><figure><img src="http://upload-images.jianshu.io/upload_images/643851-187240a411969045.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="make success"><figcaption>make success</figcaption></figure><blockquote><p>第八步 ， 运行</p></blockquote><figure><img src="http://upload-images.jianshu.io/upload_images/643851-a838074a544d9331.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="run"><figcaption>run</figcaption></figure><p>如果使用的是genymotion模拟器 ， 这需要在<code>abiFilters</code>加入<code>x86</code> ，不然项目会运行不起来的 。 当然， 也可以使用一个genymotion的<code>arm</code>插件 ， 这样不配置<code>x86</code>也可以运行 。</p><pre class="hljs"><code>// 生成.so库的目标平台
abiFilters &quot;armeabi-v7a&quot; , &quot;armeabi&quot; , &quot;x86&quot;
</code></pre><h3 id="结语">结语 <a class="markdownIt-Anchor" href="#结语">#</a></h3><p>做为Android开发者 ， 从最开始的Eclipse开发工具 ， 到现在日渐成熟的Android Studio ， 还有几乎可以看得见成长的Android System ， 我很庆幸 ， 从一开始就选择了Android平台 ， 从初学Android到现在的日渐深入 ， Android在成长 ， 我也在成长 。见证了Android从一个丑小鸭变成了 ， 一个羽翼渐丰的白天鹅 ， 不论从操作系统的易用性和UI友好性 ， 它的成长都是有目共睹的 。感谢Android 。</p><blockquote><p>每一个人的成长背后 ， 都离不开所有人支持 ， 我们是一个单独的个体 ， 又是社会网状结构的一个点 ， 我们既独立又互相联系 。</p></blockquote><h3 id="关于android-studio-22">关于Android Studio 2.2 <a class="markdownIt-Anchor" href="#关于android-studio-22">#</a></h3><p>我很期待这个版本 ， 对于C/C++的支持非常友好 ， 省却了很多繁琐的操作 ， 比Eclipse好用的太多 。</p><h3 id="参考">参考 <a class="markdownIt-Anchor" href="#参考">#</a></h3><p><a href="http://tools.android.com/tech-docs/external-c-builds" target="_blank" rel="noopener">Building C++ in Android Studio with CMake or ndk-build</a></p></div><div dir="ltr" class="level article-bar is-mobile"><div class="level-item has-text-centered"><a title="previous page" class="previouse-article-link" href="../ndk/index.html"><span class="icon icon-previous" data-icon="previous"></span><span class="link-content">&laquo; Previous</span></a></div><div class="level-item has-text-centered"><a title="font size" class="link-item link-item-size"><span class="icon icon-size" data-icon="size"></span></a></div><div class="level-item has-text-centered"><a title="table of content" class="link-item link-item-toc"><span class="icon icon-toc" data-icon="toc"></span></a></div><div class="level-item has-text-centered"><a title="top" href="#"><span class="icon icon-up" data-icon="up"></span> <span class="link-content">⤊ Top</span></a></div><div class="level-item has-text-centered"><a title="next page" class="next-article-link" href="../ndk/ndk-2-file-split-join.html"><span class="icon icon-next" data-icon="next"></span><span class="link-content">Next &raquo;</span></a></div></div></div><div class="column is-2-widescreen is-hidden"></div></div><div class="columns foot"><div class="column is-3 is-offset-9 build-by">Build by <a href="https://github.com/ruanyf/loppo" target="_blank">Loppo</a> 0.6.15</div></div><div class="book-toc notification is-warning is-hidden"><h3>Table of chapters &nbsp;<span class="title-close"><a class="button is-danger"> Close</a></span></h3><ul class="chapter-area"><li class="chapter-item"><a href="../c/index.html">C语言基础</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../c/c-1-basic.html">基础语法</a></li><li class="chapter-item"><a href="../c/c-2-pointer.html">指针内存分析</a></li><li class="chapter-item"><a href="../c/c-3-func-2pointer.html">函数与二级指针</a></li><li class="chapter-item"><a href="../c/c-4-func-pointer.html">函数指针</a></li><li class="chapter-item"><a href="../c/c-5-dynamic-m.html">动态内存分配</a></li><li class="chapter-item"><a href="../c/c-6-str-op.html">字符操作</a></li><li class="chapter-item"><a href="../c/c-7-struct-pointer.html">结构体与指针</a></li><li class="chapter-item"><a href="../c/c-8-file-io.html">文件IO</a></li><li class="chapter-item"><a href="../c/c-9-enum.html">联合体与枚举</a></li><li class="chapter-item"><a href="../c/c-10-jni.html">预编译及jni-h分析</a></li></ul><li class="chapter-item"><a href="../cpp/index.html">C++基础</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../cpp/cpp-1-namespace-struct-ref.html">命名空间结构体和引用</a></li><li class="chapter-item"><a href="../cpp/cpp-2-constructor-copy_func.html">构造函数，析构函数，拷贝构造函数</a></li><li class="chapter-item"><a href="../cpp/cpp-3-oop.html">new对象，继承，友元函数，函数的可变参数</a></li><li class="chapter-item"><a href="../cpp/cpp-4-template-exception.html">多态，模板，异常</a></li></ul><li class="chapter-item"><a href="../jni/index.html">Java与C通信的桥梁-JNI</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../jni/jni-1-basic.html">JNI概念及开发流程</a></li><li class="chapter-item"><a href="../jni/jni-2-h-file.html">头文件分析</a></li><li class="chapter-item"><a href="../jni/jni-3-call-java-field-method.html">C语言调用Java字段与方法</a></li><li class="chapter-item"><a href="../jni/jni-4-call-constructor-method.html">C语言调用构造方法</a></li><li class="chapter-item"><a href="../jni/jni-5-ref-handle.html">对象引用的处理</a></li></ul><li class="chapter-item"><a href="../ndk/index.html">Android NDK编写</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-collapse" data-icon="collapse"></span></a></li><ul class="chapter-level-1 chapter-level-1-current"><li class="chapter-item chapter-item-current"><a href="../ndk/ndk-1-as-ndk.html">使用Android-Studio编写NDK</a></li><li class="chapter-item"><a href="../ndk/ndk-2-file-split-join.html">文件加密解密与分割合并</a></li><li class="chapter-item"><a href="../ndk/ndk-3-update-1.html">增量更新之服务器端生成差分包</a></li><li class="chapter-item"><a href="../ndk/ndk-4-update-2.html">增量更新之客户端合并差分包</a></li><li class="chapter-item"><a href="../ndk/ndk-5-conf.html">基于已有项目的NDK环境配置</a></li></ul></ul></div><div class="progress-indicator"></div><!-- SCRIPTS --><script>var LOPPO={current_path:"ndk/ndk-1-as-ndk.md",relative_root_path:"../",article_toc:'<ul class="markdownIt-TOC">\n<li>\n<ul>\n<li><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83">开发环境</a></li>\n<li><a href="#%E5%85%B3%E4%BA%8E%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E8%AF%B4%E6%98%8E">关于开发环境的说明</a></li>\n<li><a href="#%E5%88%9B%E5%BB%BAndk%E9%A1%B9%E7%9B%AE">创建NDK项目</a></li>\n<li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li>\n<li><a href="#%E5%85%B3%E4%BA%8Eandroid-studio-22">关于Android Studio 2.2</a></li>\n<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>\n</ul>\n</li>\n</ul>\n'}</script><script src="../assets/js/app.js"></script></body></html>